var X=Object.defineProperty;var Y=(h,e,t)=>e in h?X(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var a=(h,e,t)=>(Y(h,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();function Q(h,e){return h===e}function tt(h,e,t){var s;const n=document.querySelector(h);n&&(n.textContent="",n.append(e.getContent())),(s=document.querySelector("#forComponent"))==null||s.remove();const o=document.createElement("style");return o.setAttribute("id","forComponent"),o.innerText=t,document.head.appendChild(o),n}class et{constructor(e,t){a(this,"_pathname");a(this,"_blockClass");a(this,"_block");this._pathname=e,this._blockClass=t,this._block=null}navigate(e){this.match(e)&&(this._pathname=e,this.render())}leave(){this._block&&this._block.hide()}match(e){return Q(e,this._pathname)}render(){this._block||(this._block=new this._blockClass),tt("#app",this._block,this._blockClass.getStyles()),this._block.show()}}const O=class{constructor(){a(this,"routes");a(this,"history");a(this,"_currentRoute");if(this.routes=[],this.history=window.history,this._currentRoute=void 0,O.__instance)return O.__instance;O.__instance=this}use(e,t){const n=new et(e,t);return this.routes.push(n),this}start(){window.onpopstate=e=>{this._onRoute(e.currentTarget.location.pathname)},this._onRoute(window.location.pathname)}_onRoute(e){const t=this.getRoute(e);this._currentRoute&&this._currentRoute.leave(),this._currentRoute=t,t.render()}go(e){this.history.pushState({},"",e),this._onRoute(e)}back(){this.history.back()}forward(){this.history.forward()}getRoute(e){return this.routes.find(t=>t.match(e))}};let q=O;a(q,"__instance");const A=new q,st=`
<main class="body">
    <form class="form">
        <firstNameComponent class="form__field" name="first_name"></firstNameComponent>
        <lastNameComponent class="form__field" name="second_name"></lastNameComponent>
        <loginComponent class="form__field" name="login"></loginComponent>
        <emailComponent class="form__field" name="email"></emailComponent>
        <passwordComponent class="form__field" name="password"></passwordComponent>
        <phoneComponent  class="form__field" name="phone"></phoneComponent>
        <div class="buttons">
            <buttonComponent class="buttons__item buttons__item--big" type="button">Зарегистрироваться</buttonComponent>
            <a href="/auth" class="buttons__item buttons__item--small" type="submit">Войти</a>
        </div>
    </form>
</main>
`,M=`.body{display:flex;flex-direction:row;justify-content:center;align-items:center;height:100dvh;margin:0;box-sizing:border-box}
`;class nt{constructor(e,t){a(this,"template","");a(this,"style","");this.template=e,this.style=t}findClosingTagIndex(e,t,n){let o=0,s="";const r=n.slice(0,t+e.length+2).length;for(let i=r;i<n.length;i++){e[s.length]===n[i]?s+=n[i]:s="";const l=e===s&&n[i-e.length]==="/",c=e===s&&n[i-e.length]==="<";if(l&&!o)return i+1;l&&o?o--:c&&o++}return null}handleLoopsInTemplate(e,t){var r,i,l,c,p,d;const n=/<.* for="let [a-zA-Z]* of [a-zA-Z]*".*>/g;let o,s=e;do{o=n.exec(s);let g="";const C=(o==null?void 0:o[0].split("<")[1])||"",v=(l=(i=(r=C.split("of "))==null?void 0:r[1])==null?void 0:i.split('"')[0])==null?void 0:l.trim(),k=((p=(c=C.split("let "))==null?void 0:c[1])==null?void 0:p.split(" of")[0].trim())||"";for(let S=0;S<C.length&&(C[S]!==" "&&C!==">");S++)g+=C[S];const T=o==null?void 0:o.index;if(g&&T){const S=this.findClosingTagIndex(g,T,s)||0,U=s.slice(T,S+1);let N="";const b=((d=t.arrays)==null?void 0:d[v])||[];for(let u=0;u<(b==null?void 0:b.length);u++)if(typeof b[u]!="object")N+=U.replaceAll(k,String(b[u]));else{let f=U;Object.keys(b[u]).forEach(_=>{f=f.replaceAll(new RegExp(`{{\\s*${k}.${_}\\s*}}`,"g"),String(b[u][_]))}),N+=f}s=s.replace(U,N.replace(/for="let [a-zA-Z]* of [a-zA-Z]*"/,""))}}while(o);return s}compile(e,t={}){var i;const n=/\{\{.*?\}\}/g;let o=this.template;o=this.handleLoopsInTemplate(o,e),(i=o.match(n))==null||i.forEach(l=>{const c=l.replaceAll(/\{\{ | \}\}/g,""),p=e[c];p&&typeof p=="string"&&(o=o.replaceAll(l,p))});const s=document.createElement("div");s.innerHTML=o;const r=s.firstElementChild;return Object.keys(t).forEach(l=>{const c=r.querySelectorAll(l.toLowerCase());c.length&&c.forEach(p=>{var g;const d=t[l];d.classList.add(...p.classList.values()),(g=p.parentNode)==null||g.insertBefore(d,p),p.remove()})}),{template:r,style:this.style}}}class ot{constructor(){a(this,"listeners");this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){if(!this.listeners[e])throw new Error(`Нет события: ${e}`);this.listeners[e]=this.listeners[e].filter(n=>n!==t)}emit(e,...t){if(!this.listeners[e])throw new Error(`Нет события: ${e}`);this.listeners[e].forEach(function(n){n(...t)})}}const E=class{constructor(e="div",t={},n,o){a(this,"_element");a(this,"_templateEngine");a(this,"_meta");a(this,"events");a(this,"props");a(this,"eventBus");a(this,"components");a(this,"setProps",e=>{e&&Object.assign(this.props,e)});const s=new ot;this._meta={tagName:e,props:t},this._templateEngine=new nt(n,o),E._style=o,this.props=this._makePropsProxy(t),this.eventBus=()=>s,this._registerEvents(s),s.emit(E.EVENTS.INIT)}_removeEvents(){let e=[];this.events&&(e=Object.keys(this.events)),e.forEach(t=>{var o;const n=(o=this.events)==null?void 0:o[t];this._element&&n&&this._element.removeEventListener(t,n)})}_addEvents(){const{events:e}=this.props;if(!e)return;const t=Object.keys(e);this.events=e,t.forEach(n=>{const o=e==null?void 0:e[n];this._element&&o&&this._element.addEventListener(n,o)})}initComponents(e){this.components=e}_registerEvents(e){e.on(E.EVENTS.INIT,this.init.bind(this)),e.on(E.EVENTS.FLOW_RENDER,this._render.bind(this))}_createResources(){const{tagName:e}=this._meta;this._element=this._createDocumentElement(e)}init(){this._createResources()}componentDidUpdate(e,t){return e===t}get element(){return this._render(),this._element}_render(){this._removeEvents();const e=this.render();this._element&&(this._element.innerHTML="",this._element.append(e.template),this._addEvents())}render(){return this._templateEngine.compile(this.props,this.components)}getContent(){return this.element}static getStyles(){return this._style}_makePropsProxy(e){return new Proxy(e,{set:(t,n,o)=>(t[n]=o,this.eventBus().emit(E.EVENTS.FLOW_RENDER),!0),deleteProperty(){throw new Error("нет доступа")}})}_createDocumentElement(e){return document.createElement(e)}show(){const e=this.getContent();e&&(e.style.display="block")}hide(){const e=this.getContent();e&&(e.style.display="none")}};let x=E;a(x,"_style"),a(x,"EVENTS",{INIT:"init",FLOW_CDM:"flow:component-did-mount",FLOW_RENDER:"flow:render",FLOW_CDU:"flow:component-did-update"});const rt=`
<div class="input-wrapper">
    <input placeholder="{{ placeholder }}" type="{{ type }}" class="input" name="{{ name }}" />
</div>
`,W=`.input-wrapper{height:100%;width:100%;position:relative}.input-wrapper:after{color:var(--red);font-size:11px;left:8px;position:absolute;display:block;content:"";bottom:-15px}.input-wrapper--alert-first_name:after,.input-wrapper--alert-second_name:after,.input-wrapper--alert-display_name:after{content:"Первая буква должна быть заглавной, не должно быть цифр и спецсимволов кроме дефиса"}.input-wrapper--alert-login:after{content:"От 3 до 20 символов, допустимы латиница, цифры и знаки(-, _), должна быть хотя бы одна буква"}.input-wrapper--alert-email:after{content:"Допустимы латиница, цифры и знаки(-, _), должен быть знак @ и точка после него, перед точкой должны быть буквы"}.input-wrapper--alert-phone:after{content:"От 10 до 15 символов, состоит из цифр, может начинается с плюса"}.input-wrapper--alert-oldPassword:after,.input-wrapper--alert-newPassword:after,.input-wrapper--alert-password:after{content:"От 8 до 40 символов, обязательно хотя бы одна заглавная буква и цифра"}.input-wrapper .input{width:100%;height:100%;border-radius:15px;border:0;box-shadow:0 3.7px 3.7px #00000040;padding-left:15px;box-sizing:border-box;margin:0}.input-wrapper .input--alert{border:1px solid var(--red)}
`,w={login:/^(?!\d+$)[\da-zA-Z_-]+$/,password:/^(?![a-z\d]+$)(?![a-zA-Z]+$).{8,40}$/,email:/^[a-zA-Z-_0-9]+@[a-zA-Z-_]+\.[a-zA-Z-_]+$/,name:/^[A-ZА-Я][А-Яа-яA-Za-z-]*$/,phone:/^\+[0-9]{10,14}$|^[0-9]{10,15}$/};function it(h,e){return h.test(e.value)}class m extends x{constructor(e={}){e.events||(e.events={}),e.events.focusout=t=>{var r,i;if(!this.props.regExp)return;const n=t==null?void 0:t.target,o=it(this.props.regExp,n),s=this.props.name;o?(n.classList.remove("input--alert"),(i=n.parentElement)==null||i.classList.remove(`input-wrapper--alert-${s}`)):(n.classList.add("input--alert"),(r=n.parentElement)==null||r.classList.add(`input-wrapper--alert-${s}`))},super("input-component",e,rt,W),m._style=W}}const at=`
<button class="button {{ class }}" type="submit">{{ text }}</button>
`,Z=`.button{width:100%;height:100%;border-radius:15px;background-color:var(--blue);color:var(--white);font-weight:700;font-size:18px;text-transform:uppercase;cursor:pointer;border:0}.button--red{padding:10px;background-color:var(--red)}
`;class y extends x{constructor(e={}){super("button-component",e,at,Z),y._style=Z}}function ct(h){let e="?";return Object.keys(h).forEach(t=>{e+=`${t}=${Array.isArray(h[t])?h[t].join(","):h[t]}&`}),e=e.replace(/&$/,""),e}class B{constructor(){a(this,"get",(e,t={})=>this.request(e,{...t,method:"GET"},t.timeout));a(this,"put",(e,t={})=>this.request(e,{...t,method:"PUT"},t.timeout));a(this,"post",(e,t={})=>this.request(e,{...t,method:"POST"},t.timeout));a(this,"delete",(e,t={})=>this.request(e,{...t,method:"DELETE"},t.timeout));a(this,"request",(e,t,n=5e3)=>new Promise((o,s)=>{const{method:r,data:i}=t,l=new XMLHttpRequest;r==="GET"&&i?l.open(r,e+ct(i)):l.open(r,e),i instanceof FormData||l.setRequestHeader("Content-Type",t.ContentType||"application/json"),l.setRequestHeader("Accept","application/json"),l.withCredentials=!0;let c=i;(t.ContentType==="application/json"||!t.ContentType&&!(i instanceof FormData))&&(c=JSON.stringify(i)),l.onload=function(){o(l)};const p=d=>{s(d)};l.timeout=n,l.onabort=p,l.onerror=p,l.ontimeout=p,r==="GET"||!i?l.send():l.send(c)}))}}class lt{constructor(){a(this,"_url");a(this,"_http");this._url="https://ya-praktikum.tech/api/v2/auth/",this._http=new B}signIn({login:e,password:t}){return this._http.post(this._url+"signin",{data:{login:e,password:t}})}signUp(e){return this._http.post(this._url+"signup",{data:e})}getUser(){return this._http.get(this._url+"user")}logOut(){return this._http.post(this._url+"logout")}}class L{constructor(){a(this,"_authApi");this._authApi=new lt}signIn(e){return this._authApi.signIn(e).then(t=>t).catch(t=>console.error(t))}signUp(e){return this._authApi.signUp(e).then(t=>t).catch(t=>console.error(t))}getUser(){return this._authApi.getUser().then(e=>JSON.parse(e.response))}logout(){return this._authApi.logOut().catch(e=>{console.error(e)})}}class D extends x{constructor(t={}){super("registration-component",t,st,M);a(this,"_authController");this.initComponents(),this._authController=new L,D._style=M+y.getStyles()+m.getStyles()}initComponents(){const t=new m({placeholder:"Логин",type:"text",name:"login",regExp:w.login}).getContent(),n=new m({placeholder:"Пароль",type:"password",name:"password",regExp:w.password}).getContent(),o=new m({placeholder:"Почта",type:"email",name:"email",regExp:w.email}).getContent(),s=new m({placeholder:"Имя",type:"text",name:"first_name",regExp:w.name}).getContent(),r=new m({placeholder:"Фамилия",type:"text",name:"second_name",regExp:w.name}).getContent(),i=new m({placeholder:"Телефон",type:"phone",name:"phone",regExp:w.phone}).getContent(),l=new y({text:"Зарегистрироваться",events:{click:c=>this.onSubmit(c)}}).getContent();this.components={buttonComponent:l,loginComponent:t,passwordComponent:n,emailComponent:o,firstNameComponent:s,lastNameComponent:r,phoneComponent:i}}onSubmit(t){var n;if(t.preventDefault(),this.components){const o={};(n=Object.values(this.components))==null||n.forEach(s=>{const r=s.querySelector("input");r&&(r.focus(),r.blur(),o[r.name]=r.value)}),this.isSignUpData(o)&&this._authController.signUp(o).then(s=>{(s==null?void 0:s.status)===200&&A.go("/chat")})}}isSignUpData(t){return!!(t!=null&&t.first_name)&&!!(t!=null&&t.second_name)&&!!(t!=null&&t.login)&&!!(t!=null&&t.email)&&!!(t!=null&&t.password)&&!!(t!=null&&t.phone)}}const pt=`
<main 
    class="body">
    <form class="form">
        <loginComponent placeholder="Логин" 
               type="text" 
               class="form__field" 
               name="login"></loginComponent>
        <passwordComponent placeholder="Пароль" type="password" class="form__field" name="password"></passwordComponent>
        <div class="buttons">
            <buttonComponent class="buttons__item buttons__item--small"></buttonComponent>
            <regisctrationButton class="buttons__item buttons__item--big">Зарегистрироваться</regisctrationButton>
        </div>
    </form>
</main>
`,F=`.body{display:flex;flex-direction:row;justify-content:center;align-items:center;height:100dvh;margin:0;box-sizing:border-box}
`;class P extends x{constructor(t={},n){t.events=n;super("auth-component",t,pt,F);a(this,"_authController");this.initComponents(),this._authController=new L,P._style=F+y.getStyles()+m.getStyles()}initComponents(){const t=new m({placeholder:"Логин",type:"text",name:"login",regExp:w.login}).getContent(),n=new m({placeholder:"Пароль",type:"password",name:"password",regExp:w.password}).getContent(),o=new y({text:"Войти",events:{click:r=>this.onSubmit(r)}}).getContent(),s=new y({text:"Зарегистрироваться",events:{click:r=>{r==null||r.preventDefault(),A.go("/sign-up")}}}).getContent();this.components={buttonComponent:o,loginComponent:t,passwordComponent:n,regisctrationButton:s}}async onSubmit(t){var n;if(t.preventDefault(),this.components){const o={login:"",password:""};let s=!1;if((n=Object.values(this.components))==null||n.forEach(r=>{const i=r.querySelector("input");i&&(i.focus(),i.blur(),i.classList.contains("input--alert")&&(s=!0),o[i.name]=i.value)}),!s){await this._authController.logout();const r=await this._authController.signIn(o);(r==null?void 0:r.status)===200&&A.go("/messenger")}}}}const ht=`
<main class="body">
    <div id="left-side-menu-wrapper" class="left-side-menu__wrapper">
        <section class="left-side-menu">
            <ul class="left-side-menu__list">
                <li class="left-side-menu__list-item" id="create-chat">Создать чат</li>
                <li class="left-side-menu__list-item" id="settings-link">Настройки</li>
            </ul>
            <div class="buttons">
                <exitButton></exitButton>
            </div>
        </section>
        <section class="create-chat-popup popup-with-users">
            <createChatInputComponent class="input-component create-chat-name"></createChatInputComponent>
            <addUserToChatBeforeCreateChatComponent class="input-component"></addUserToChatBeforeCreateChatComponent>
            <ul class="users-for-chat"></ul>
            <ul class="users-in-chat"></ul>
            <createChatButtonComponent class="create-chat-popup__btn"></createChatButtonComponent>
        </section>
        <section class="add-users-chat-popup popup-with-users">
            <addUserToChatComponent class="input-component"></addUserToChatComponent>
            <ul class="users-for-chat"></ul>
            <ul class="users-in-chat">
                <li for="let user of chatUsers" class="users-in-chat__item"><span>{{ user.login }}</span><span data-id="{{ user.id }}" class="remove-user clickable">Удалить</span></li>
            </ul>
            <addUserToChatButtonComponent class="create-chat-popup__btn"></addUserToChatButtonComponent>
            <removeChatButton></removeChatButton>
        </section>
        <div id="shadow" class="shadow"></div>
    </div>
    <section class="chat-preview__container">
        <div class="search__wrapper">
            <div id="click-at-sandwich" (click)="showLeftSideMenu()" class="sandwich__wrapper">
                <div class="sandwich"></div>
            </div>
            <input placeholder="Поиск" class="input search" type="search" name="" id="">
        </div>
    
        <ul class="chat-preview__list">
            <li for="let chat of chats" data-id="chat-{{ chat.id }}" class="chat-preview">
                <img class="chat-preview__image" src="/icon.svg" alt="">
                <div class="chat-preview__right-side">
                    <h1 class="chat-preview__text chat-preview__text--title">{{ chat.title }}</h1>
                </div>
            </li>
        </ul>
    </section>
    <section class="chat">
        <div class="chat__title">
            <span class="clickable" id="chat-settings">{{ chatTitle }}</span>
        </div>
        <ul class="chat__feed">
            <li for="let message of messages" class="chat__message {{ message.class }}">
                <img class="chat-preview__image" src="/icon.svg" alt="">
                <p class="chat__text">{{ message.content }}</p>
            </li>
        </ul>
        <div>
            <textarea id="chat-textarea" type="text" placeholder="Писать сюда..." class="input chat__input" name="message"></textarea>
            <button class="send-button" id="send-message"><img src="icons8-send-button-30.png" alt=""></button>
            <span class="send-description">Отправка - ctrl + Enter</span>
        </div>
    </section>

</main>
`,H=`.chat-preview{display:flex;flex-direction:row;align-items:center;font-family:Inter,sans-serif;padding:5px}.chat-preview:hover{background-color:var(--orange);cursor:pointer}.chat-preview__image{width:50px;height:50px;border-radius:50%;object-fit:cover;object-position:50% 50%}.chat-preview__container{position:relative;width:337px;height:100dvh;background-color:var(--bg-color);display:flex;flex-direction:column}.chat-preview__text{font-style:normal;font-weight:700;font-size:15px;margin:0}.chat-preview__text--title{margin-bottom:12px}.chat-preview__right-side{margin-left:10px}.chat-preview__list{padding-left:0;overflow:auto}.input{margin-top:18px;margin-bottom:16px;width:263px;height:28px;border-radius:15px;border-width:0;padding-left:10px}.input:focus{outline:1px solid black}.search__wrapper{display:flex;flex-direction:row;align-items:center}.sandwich__wrapper{position:relative;width:30px;height:24px;margin-left:15px;margin-right:10px;cursor:pointer}.sandwich,.sandwich:after,.sandwich:before{display:block;background-color:var(--black);position:absolute;top:50%;height:4px;width:30px;transform:translateY(-50%);border-radius:2px}.sandwich:after{content:"";margin-top:-8px}.sandwich:before{content:"";margin-top:8px}.body{display:flex;flex-direction:row;width:100%}.chat{position:relative;flex-grow:1;padding-bottom:90px;display:flex;flex-direction:column;padding-right:0;padding-top:50px}.chat__input{background-color:var(--bg-color);min-height:45px;position:absolute;bottom:25px;width:90%;left:50%;transform:translate(-50%);box-sizing:border-box;resize:none;overflow:hidden;margin-bottom:0;padding-top:14px}.chat__feed{list-style-type:none;margin-bottom:0;height:calc(100dvh - 156px);width:calc(100dvw - 377px);overflow:auto;margin-top:0;padding-top:10px;padding-right:10px}.chat__text{margin-top:0;background-color:var(--bg-color);padding:20px 10px 20px 20px;border-radius:15px}.chat__message{width:400px;display:flex;gap:5px}.chat__message--right{flex-direction:row-reverse;margin-left:auto}.chat__title{width:100dvw;background-color:var(--bg-color);height:50px;position:fixed;line-height:50px;font-size:20px;font-weight:700;padding-left:15px;color:var(--black);top:0}.buttons{width:100%;justify-content:center;position:absolute;bottom:25px}.buttons__item{height:45px;line-height:45px}.left-side-menu{display:flex;position:absolute;left:0;top:0;width:334px;height:100dvh;z-index:2;background-color:var(--bg-color)}.left-side-menu__list{display:flex;flex-direction:column;list-style-type:none}.left-side-menu__list-item{height:56px;line-height:56px;padding-left:24px;cursor:pointer;font-size:20px;font-weight:700}.left-side-menu__wrapper{display:none;width:0;overflow-y:hidden}.shadow{top:0;left:0;position:absolute;background-color:var(--shadow);width:100dvw;height:100dvh;z-index:1}.add-users-chat-popup,.create-chat-popup{top:50%;left:50%;transform:translate(-50%,-50%);padding:25px;position:absolute;z-index:2;background-color:var(--bg-color);border-radius:15px;display:none;flex-direction:column;gap:10px}.add-users-chat-popup__btn,.create-chat-popup__btn{padding-top:10px;padding-bottom:10px;background-color:var(--blue);border-radius:15px}.input-component{height:40px}.clickable{cursor:pointer}.users-in-chat,.users-for-chat{list-style:none}.users-for-chat{height:100px;overflow-y:auto;border:1px solid var(--black)}.users-in-chat{padding-left:0;display:flex;flex-direction:column}.users-in-chat__item{display:flex;justify-content:space-between}.send-button{position:absolute;border-radius:50%;right:60px;bottom:34px;width:30px;height:30px;border:0;background:0;cursor:pointer}.send-description{position:absolute;left:52px;bottom:12px;font-size:11px}
`;class ut{constructor(){a(this,"_url");a(this,"_http");this._url="https://ya-praktikum.tech/api/v2/chats/",this._http=new B}createChat(e){return this._http.post(this._url,{data:{title:e}})}getChats(e,t){return this._http.get(this._url+`?offset=${e}&limit=${t}`)}addUserToChat(e){return this._http.put(this._url+"users",{data:e})}getToken(e){return this._http.post(this._url+"token/"+e)}getUsers(e){return this._http.get(this._url+e+"/users")}deleteChatUser(e,t){return this._http.delete(this._url+"users",{data:{users:[t],chatId:e}})}removeChat(e){return this._http.delete(this._url,{data:{chatId:e}})}}class dt{constructor(){a(this,"_chatApi");this._chatApi=new ut}createChat(e){return this._chatApi.createChat(e).then(t=>JSON.parse(t.response)).catch(t=>console.error(t))}getChats(e,t){return this._chatApi.getChats(e,t).then(n=>JSON.parse(n.response)).catch(n=>(console.error(n),[]))}addUserToChat(e){return this._chatApi.addUserToChat(e).catch(t=>console.error(t))}getToken(e){return this._chatApi.getToken(e).then(t=>JSON.parse(t.response)).catch(t=>console.error(t))}getUsers(e){return this._chatApi.getUsers(e).then(t=>JSON.parse(t.response)).catch(t=>console.error(t))}deleteChatUsers(e,t){return this._chatApi.deleteChatUser(e,t).catch(n=>console.error(n))}removeChat(e){return this._chatApi.removeChat(e).catch(t=>console.error(t))}}class mt{constructor(){a(this,"_url");a(this,"_http");this._url="https://ya-praktikum.tech/api/v2/user/",this._http=new B}searchUser(e){return this._http.post(this._url+"search",{data:{login:e}})}changeUserData(e){return this._http.put(this._url+"profile",{data:e})}changeUserPassword(e){return this._http.put(this._url+"password",{data:e})}changeUserAvatar(e){return this._http.put(this._url+"profile/avatar",{data:e,ContentType:"multipart/form-data"})}}class G{constructor(){a(this,"_userApi");this._userApi=new mt}searchUser(e){return this._userApi.searchUser(e).then(t=>JSON.parse(t.response)).catch(t=>console.error(t))}changeUserData(e){return this._userApi.changeUserData(e).catch(t=>console.error(t))}changeUserPassword(e){return this._userApi.changeUserPassword(e).catch(t=>console.error(t))}changeUserAvatar(e){return this._userApi.changeUserAvatar(e).then(t=>JSON.parse(t.response))}}class _t{constructor(){a(this,"_url");this._url="wss://ya-praktikum.tech/ws/"}connectChat(e,t,n){return new WebSocket(`${this._url}chats/${e}/${t}/${n}`)}}class gt{constructor(){a(this,"_websocketApi");this._websocketApi=new _t}connectChat(e,t,n){return this._websocketApi.connectChat(e,t,n)}}class R extends x{constructor(t={}){let n=!1;t.click=async s=>{var r,i,l,c,p,d,g,C,v,k,T,S,U,N,b;if((r=s==null?void 0:s.target)!=null&&r.closest("#click-at-sandwich")){const u=document.querySelector("#left-side-menu-wrapper"),f=document.querySelector(".add-users-chat-popup"),_=document.querySelector(".left-side-menu");_&&(_.style.display="flex"),u&&(u.style.display="flex"),f&&(f.style.display="none")}if((i=s==null?void 0:s.target)!=null&&i.closest("#shadow")){const u=document.querySelector("#left-side-menu-wrapper"),f=document.querySelector(".add-users-chat-popup");u&&(u.style.display="none");const _=document.querySelector(".create-chat-popup");_&&(_.style.display="none"),f&&(f.style.display="none")}if((l=s==null?void 0:s.target)!=null&&l.closest("#create-chat")){const u=document.querySelector(".create-chat-popup");u&&(u.style.display="flex")}if((c=s==null?void 0:s.target)!=null&&c.closest("#send-message")){const u=(p=document.querySelector("#chat-textarea"))==null?void 0:p.value;(d=this._chatSocket)==null||d.send(JSON.stringify({content:u,type:"message"}))}if((g=s==null?void 0:s.target)!=null&&g.closest("#settings-link")&&A.go("/settings"),(C=s==null?void 0:s.target)!=null&&C.closest(".remove-user")){const u=(v=s==null?void 0:s.target)==null?void 0:v.closest(".remove-user"),f=u.dataset.id;this._chatId&&f&&this._chatController.deleteChatUsers(String(this._chatId),f).then(()=>{var _;(_=u.parentElement)==null||_.remove()})}if((k=s==null?void 0:s.target)!=null&&k.closest("#chat-settings")){const u=document.querySelector(".add-users-chat-popup"),f=document.querySelector("#left-side-menu-wrapper"),_=document.querySelector(".left-side-menu");f&&(f.style.display="flex"),u&&(u.style.display="flex"),_&&(_.style.display="none")}if((T=s==null?void 0:s.target)!=null&&T.closest(".chat-preview")){const u=(S=(s==null?void 0:s.target).dataset.id)==null?void 0:S.split("-")[1];if(this._messages=[],this._chatSocket&&(this._chatSocket.close(1e3),this._chatSocket=void 0),this._chatTitle=((b=(N=(U=s==null?void 0:s.target)==null?void 0:U.closest(".chat-preview"))==null?void 0:N.querySelector(".chat-preview__text--title"))==null?void 0:b.textContent)||" ",this._chatId=Number(u),u!==void 0&&this._userId){this._getUsers(u);const{token:f}=await this._chatController.getToken(String(u));this._chatSocket=this._webSocketController.connectChat(String(this._userId),String(u),f),this._chatSocket.onopen=()=>{var I;(I=this._chatSocket)==null||I.send(JSON.stringify({content:"0",type:"get old"})),this._messageIndex=20;const _=setInterval(()=>{this._chatSocket?this._chatSocket.send(JSON.stringify({type:"ping"})):clearInterval(_)},5e3)},this._chatSocket.addEventListener("message",_=>{var I;if(!(JSON.parse(_.data).type==="pong"||JSON.parse(_.data).type==="user connected")){if(JSON.parse(_.data).type==="message"){const $={content:JSON.parse(_.data).content,class:JSON.parse(_.data).user_id===Number(this._userId)?"chat__message--left":"chat__message--right"};this._messages.push($)}else if(JSON.parse(_.data).length){const $=JSON.parse(_.data).map(z=>(z.class=z.user_id===Number(this._userId)?"chat__message--left":"chat__message--right",z)).reverse();this._messages.unshift(...$),(I=this._chatSocket)==null||I.send(JSON.stringify({content:this._messageIndex,type:"get old"})),this._messageIndex+=20}this.setProps({arrays:{messages:this._messages,chats:this._chats,chatUsers:this._chatUsers},chatTitle:this._chatTitle})}})}}},t.keydown=s=>{var i,l;if(s.repeat)return;n=!!((s==null?void 0:s.target).closest("#chat-textarea")&&s.key==="Control")||n;const r=!!(!s.repeat&&(s==null?void 0:s.target).closest("#chat-textarea")&&s.key==="Enter");if(n&&r){const c=(i=(s==null?void 0:s.target).closest("#chat-textarea"))==null?void 0:i.value;(l=this._chatSocket)==null||l.send(JSON.stringify({content:c,type:"message"}))}},t.keyup=s=>{n=s.key!=="Control"&&n};super("chat-component",{fullMessage:"Полное сообщение",message:"Последнее сообщение из ...",chatTitle:" ",events:t,arrays:{chats:[{id:202,title:"Чат"}],messages:[{}]}},ht,H);a(this,"_chatController");a(this,"_userController");a(this,"_authController");a(this,"_webSocketController");a(this,"_usersToChat",[]);a(this,"_userId");a(this,"_chats",[]);a(this,"_messages",[]);a(this,"_chatSocket");a(this,"_messageIndex",0);a(this,"_chatTitle"," ");a(this,"_chatId");a(this,"_chatUsers",[]);this.initComponents(),this._chatController=new dt,this._userController=new G,this._authController=new L,this._webSocketController=new gt,R._style=m.getStyles()+H+y.getStyles(),this._getChats(),this._authController.getUser().then(s=>{this._userId=s.id}),window.onload=()=>{const s=document.querySelector(".chat"),r={attributes:!0,childList:!0,subtree:!0},i=new MutationObserver(()=>{var l;(l=document.querySelector(".chat__feed"))==null||l.scrollTo(0,1e5)});s&&i.observe(document,r)}}initComponents(){const t=new m({placeholder:"Название чата",type:"text",name:"create-chat"}).getContent(),n=new y({text:"Создать чат",events:{click:async()=>{const c=document.querySelector(".create-chat-name input").value,p=await this._chatController.createChat(c);await this._chatController.addUserToChat({users:this._usersToChat.map(d=>Number(d.id)),chatId:p.id}),this._getChats()}}}).getContent(),o=new y({text:"Добавить пользователей",events:{click:async()=>{if(this._chatId){await this._chatController.addUserToChat({users:this._usersToChat.map(d=>Number(d.id)),chatId:this._chatId});const c=document.querySelector(".add-users-chat-popup .users-in-chat"),p=[];this._usersToChat.forEach(d=>{var k;const g=document.createElement("li");g.classList.add("users-in-chat__item");const C=document.createElement("span");C.textContent=d.login;const v=document.createElement("span");v.dataset.id=d.id,v.classList.add("remove-user","clickable"),v.textContent="Удалить",g.append(C,v),p.push(g),(k=c==null?void 0:c.lastChild)==null||k.remove()}),c==null||c.append(...p)}}}}).getContent(),s=new y({text:"Удалить чат",class:"button--red",events:{click:async()=>{this._removeChat()}}}).getContent(),r=new y({text:"Выйти",class:"button--red",events:{click:async()=>{this._authController.logout().then(()=>{A.go("/")})}}}).getContent(),i=new m({placeholder:"Найти пользователя",type:"text",events:{input:c=>{var d;const p=(d=c==null?void 0:c.target)==null?void 0:d.value;this._addUsers((c==null?void 0:c.target).closest(".popup-with-users"),p)}}}).getContent(),l=new m({placeholder:"Найти пользователя",type:"text",events:{input:c=>{const p=(c==null?void 0:c.target).value;this._addUsers((c==null?void 0:c.target).closest(".popup-with-users"),p)}}}).getContent();this.components={createChatButtonComponent:n,createChatInputComponent:t,addUserToChatBeforeCreateChatComponent:i,exitButton:r,addUserToChatComponent:l,addUserToChatButtonComponent:o,removeChatButton:s}}_addUsers(t,n){this._userController.searchUser(n).then(o=>{const s=t==null?void 0:t.querySelector(".users-for-chat");if(o&&s){s.textContent="";const r=[];o.forEach((i,l)=>{const c=document.createElement("li");c.classList.add("clickable"),c.textContent=i.login,c.dataset.id=String(l),c.addEventListener("click",()=>{var g;this._usersToChat.push(i);const p=document.createElement("li");p.classList.add("clickable","users-in-chat__item"),p.textContent=i.login;const d=document.createElement("span");d.textContent="Убрать",d.addEventListener("click",()=>{this._usersToChat=this._usersToChat.filter(C=>C.login!==i.login),p.remove()}),p.append(d),(g=t.querySelector(".users-in-chat"))==null||g.append(p)}),r.push(c)}),s.append(...r)}})}_getUsers(t){this._chatController.getUsers(t).then(n=>{this._chatUsers=n})}async _getChats(){let t=[],o=0;this._chats=[];do t=(await this._chatController.getChats(o,10)).map((r,i)=>(r.index=i,r)),this._chats.push(...t),o+=10;while(t.length===10);this.setProps({arrays:{chats:this._chats},chatTitle:this._chatTitle})}async _removeChat(){var t;this._chatId&&await this._chatController.removeChat(this._chatId),this._chatId=void 0,this._chatTitle=" ",this._messages=[],this._messageIndex=0,this._chatUsers=[],(t=this._chatSocket)==null||t.close(1e3),this._chatSocket=void 0,this._getChats()}}const ft=`
<main class="body">
    <h1>{{ errorCode }}</h1>
</main>
`,V=`.body{display:flex;flex-direction:row;justify-content:center;align-items:center;height:100dvh;margin:0;box-sizing:border-box;font-size:50px}
`;class j extends x{constructor(){const t=new URLSearchParams(window.location.search).get("errorCode")??"500";super("chat-component",{errorCode:t},ft,V),j._style=V}}const wt=`
<main class="body">
    <form id="avatar" class="form form--without-gap">
        <img class="form__icon" src="/icon.svg" alt="">
        <label class="input-file">
            <input class="input-file__input" type="file" name="avatar">
            <span class="input-file__button">Поменять аватар</span>           
        </label>
    </form>
    <form class="form">
        <firstNameComponent placeholder="Имя" type="text" class="form__field" name="first_name"></firstNameComponent>
        <lastNameComponent placeholder="Фамилия" type="text" class="form__field" name="second_name"></lastNameComponent>
        <displayNameComponent placeholder="Отображаемое имя" type="text" class="form__field" name="display_name"></displayNameComponent>
        <loginComponent placeholder="Логин" type="text" class="form__field" name="login"></loginComponent>
        <emailComponent placeholder="Почта" type="email" class="form__field" name="email"></emailComponent>
        <phoneComponent placeholder="Телефон" type="phone" class="form__field" name="phone"></phoneComponent>
        <div class="buttons">
            <saveDataButtonComponent class="buttons__item buttons__item--small" type="submit">Сохранить</saveDataButtonComponent>
        </div>
    </form>
    <hr class="hr-line">
    <form class="form">
        <oldPasswordComponent placeholder="Старый пароль" type="text" class="form__field" name="oldPassword"></oldPasswordComponent>
        <newPasswordComponent placeholder="Новый пароль" type="password" class="form__field" name="newPassword"></newPasswordComponent>
        <div class="buttons">
            <savePasswordButtonComponent class="buttons__item buttons__item--small" type="submit">Сохранить</savePasswordButtonComponent>
        </div>
    </form>
</main>
`,K=`.body{background-color:var(--bg-color);height:calc(100dvh - 72px);width:calc(100dvw - 72px);gap:26px;display:flex;flex-direction:column;padding:36px}.form{width:100%;border-radius:0;padding:0;gap:21px;box-shadow:none}.form__field{height:45px}.form--without-gap{gap:0}.form__icon{border-radius:50%}.buttons{justify-content:center}.buttons__item{height:33px;line-height:33px}.input-file{position:relative;display:inline-block}.input-file__button{position:relative;display:inline-block;cursor:pointer;outline:none;font-size:14px;vertical-align:middle;color:#4965d6;text-align:center;border-radius:4px;line-height:14px;height:14px;box-sizing:border-box;border:none;margin:0;transition:background-color .2s;padding:0;text-decoration:underline}.input-file__input{position:absolute;z-index:-1;opacity:0;display:block;width:0;height:0}
`;class J extends x{constructor(){super("chat-component",{events:{change:n=>{var s;if((s=n==null?void 0:n.target)==null?void 0:s.files){const r=document.getElementById("avatar"),i=new FormData(r);this._userController.changeUserAvatar(i).then(l=>{l.avatar&&(document.querySelector(".form__icon").src="https://ya-praktikum.tech/api/v2/resources"+l.avatar)})}}}},wt,K);a(this,"_authController");a(this,"_userController");this._authController=new L,this._userController=new G,this.initComponents(),this._getUserInfo(),J._style=K+m._style+y._style}initComponents(){const t=new m({placeholder:"Имя",type:"text",name:"first_name",regExp:w.name}).getContent(),n=new m({placeholder:"Фамилия",type:"text",name:"second_name",regExp:w.name}).getContent(),o=new m({placeholder:"Отображаемое имя",type:"text",name:"display_name",regExp:w.name}).getContent(),s=new m({placeholder:"Логин",type:"text",name:"login",regExp:w.login}).getContent(),r=new m({placeholder:"Почта",type:"email",name:"email",regExp:w.email}).getContent(),i=new m({placeholder:"Телефон",type:"phone",name:"phone",regExp:w.phone}).getContent(),l=new y({text:"Сохранить",events:{click:g=>this.onSubmit(g,"data")}}).getContent(),c=new m({placeholder:"Пароль",type:"password",name:"oldPassword",regExp:w.password}).getContent(),p=new m({placeholder:"Пароль",type:"password",name:"newPassword",regExp:w.password}).getContent(),d=new y({text:"Сохранить",events:{click:g=>this.onSubmit(g,"password")}}).getContent();this.components={saveDataButtonComponent:l,savePasswordButtonComponent:d,loginComponent:s,oldPasswordComponent:c,newPasswordComponent:p,emailComponent:r,firstNameComponent:t,lastNameComponent:n,phoneComponent:i,displayNameComponent:o}}onSubmit(t,n){var o;if(t.preventDefault(),this.components){const s={};(o=Object.values(this.components))==null||o.forEach(r=>{const i=r.querySelector("input");i&&(n==="password"&&i.type===n||n==="data"&&i.type!=="password")&&(i.focus(),i.blur(),s[i.name]=i.value)}),n==="data"?this._userController.changeUserData(s).then(r=>{(r==null?void 0:r.status)===200&&this._showMessage("Изменения сохранены")}):this._userController.changeUserPassword(s).then(r=>{(r==null?void 0:r.status)===200&&this._showMessage("Пароль изменен")})}}_getUserInfo(){this._authController.getUser().then(t=>{document.querySelector("input[name=first_name]").value=t.first_name,document.querySelector("input[name=second_name]").value=t.second_name,document.querySelector("input[name=display_name]").value=t.display_name,document.querySelector("input[name=login]").value=t.login,document.querySelector("input[name=email]").value=t.email||"",document.querySelector("input[name=phone]").value=t.phone||"",t.avatar&&(document.querySelector(".form__icon").src="https://ya-praktikum.tech/api/v2/resources"+t.avatar)})}_showMessage(t){const n=document.createElement("div");n.classList.add("alert-popup"),n.textContent=t,document.body.append(n),setTimeout(()=>{n.remove()},5e3)}}A.use("/",P).use("/sign-up",D).use("/auth",P).use("/messenger",R).use("/error",j).use("/settings",J).start();
