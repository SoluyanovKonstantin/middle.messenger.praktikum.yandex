var H=Object.defineProperty;var K=(h,t,e)=>t in h?H(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var l=(h,t,e)=>(K(h,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();function G(h,t){return h===t}function X(h,t,e){var s;const n=document.querySelector(h);n&&(n.textContent="",n.append(t.getContent())),(s=document.querySelector("#forComponent"))==null||s.remove();const o=document.createElement("style");return o.setAttribute("id","forComponent"),o.innerText=e,document.head.appendChild(o),n}class Y{constructor(t,e){l(this,"_pathname");l(this,"_blockClass");l(this,"_block");this._pathname=t,this._blockClass=e,this._block=null}navigate(t){this.match(t)&&(this._pathname=t,this.render())}leave(){this._block&&this._block.hide()}match(t){return G(t,this._pathname)}render(){this._block||(this._block=new this._blockClass),X("#app",this._block,this._blockClass.getStyles()),this._block.show()}}const A=class{constructor(){l(this,"routes");l(this,"history");l(this,"_currentRoute");if(this.routes=[],this.history=window.history,this._currentRoute=void 0,A.__instance)return A.__instance;A.__instance=this}use(t,e){const n=new Y(t,e);return this.routes.push(n),this}start(){window.onpopstate=t=>{this._onRoute(t.currentTarget.location.pathname)},this._onRoute(window.location.pathname)}_onRoute(t){const e=this.getRoute(t);this._currentRoute&&this._currentRoute.leave(),this._currentRoute=e,e.render()}go(t){this.history.pushState({},"",t),this._onRoute(t)}back(){this.history.back()}forward(){this.history.forward()}getRoute(t){return this.routes.find(e=>e.match(t))}};let O=A;l(O,"__instance");const U=new O,Q=`
<main class="body">
    <form class="form">
        <firstNameComponent class="form__field" name="first_name"></firstNameComponent>
        <lastNameComponent class="form__field" name="second_name"></lastNameComponent>
        <loginComponent class="form__field" name="login"></loginComponent>
        <emailComponent class="form__field" name="email"></emailComponent>
        <passwordComponent class="form__field" name="password"></passwordComponent>
        <phoneComponent  class="form__field" name="phone"></phoneComponent>
        <div class="buttons">
            <buttonComponent class="buttons__item buttons__item--big" type="button">Зарегистрироваться</buttonComponent>
            <a href="/auth" class="buttons__item buttons__item--small" type="submit">Войти</a>
        </div>
    </form>
</main>
`,R=`.body{display:flex;flex-direction:row;justify-content:center;align-items:center;height:100dvh;margin:0;box-sizing:border-box}
`;class tt{constructor(t,e){l(this,"template","");l(this,"style","");this.template=t,this.style=e}findClosingTagIndex(t,e,n){let o=0,s="";const r=n.slice(0,e+t.length+2).length;for(let i=r;i<n.length;i++){t[s.length]===n[i]?s+=n[i]:s="";const a=t===s&&n[i-t.length]==="/",c=t===s&&n[i-t.length]==="<";if(a&&!o)return i+1;a&&o?o--:c&&o++}return null}handleLoopsInTemplate(t,e){var r,i,a,c,p,g;const n=/<.* for="let [a-zA-Z]* of [a-zA-Z]*".*>/g;let o,s=t;do{o=n.exec(s);let f="";const x=(o==null?void 0:o[0].split("<")[1])||"",I=(a=(i=(r=x.split("of "))==null?void 0:r[1])==null?void 0:i.split('"')[0])==null?void 0:a.trim(),N=((p=(c=x.split("let "))==null?void 0:c[1])==null?void 0:p.split(" of")[0].trim())||"";for(let S=0;S<x.length&&(x[S]!==" "&&x!==">");S++)f+=x[S];const E=o==null?void 0:o.index;if(f&&E){const S=this.findClosingTagIndex(f,E,s)||0,m=s.slice(E,S+1);let _="";const u=((g=e.arrays)==null?void 0:g[I])||[];for(let C=0;C<(u==null?void 0:u.length);C++)if(typeof u[C]!="object")_+=m.replaceAll(N,String(u[C]));else{let v=m;Object.keys(u[C]).forEach(T=>{v=v.replaceAll(new RegExp(`{{\\s*${N}.${T}\\s*}}`,"g"),String(u[C][T]))}),_+=v}s=s.replace(m,_.replace(/for="let [a-zA-Z]* of [a-zA-Z]*"/,""))}}while(o);return s}compile(t,e={}){var i;const n=/\{\{.*?\}\}/g;let o=this.template;o=this.handleLoopsInTemplate(o,t),(i=o.match(n))==null||i.forEach(a=>{const c=a.replaceAll(/\{\{ | \}\}/g,""),p=t[c];p&&typeof p=="string"&&(o=o.replaceAll(a,p))});const s=document.createElement("div");s.innerHTML=o;const r=s.firstElementChild;return Object.keys(e).forEach(a=>{const c=r.querySelectorAll(a.toLowerCase());c.length&&c.forEach(p=>{var f;const g=e[a];g.classList.add(...p.classList.values()),(f=p.parentNode)==null||f.insertBefore(g,p),p.remove()})}),{template:r,style:this.style}}}class et{constructor(){l(this,"listeners");this.listeners={}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){if(!this.listeners[t])throw new Error(`Нет события: ${t}`);this.listeners[t]=this.listeners[t].filter(n=>n!==e)}emit(t,...e){if(!this.listeners[t])throw new Error(`Нет события: ${t}`);this.listeners[t].forEach(function(n){n(...e)})}}const k=class{constructor(t="div",e={},n,o){l(this,"_element");l(this,"_templateEngine");l(this,"_meta");l(this,"events");l(this,"props");l(this,"eventBus");l(this,"components");l(this,"setProps",t=>{t&&Object.assign(this.props,t)});const s=new et;this._meta={tagName:t,props:e},this._templateEngine=new tt(n,o),k._style=o,this.props=this._makePropsProxy(e),this.eventBus=()=>s,this._registerEvents(s),s.emit(k.EVENTS.INIT)}_removeEvents(){let t=[];this.events&&(t=Object.keys(this.events)),t.forEach(e=>{var o;const n=(o=this.events)==null?void 0:o[e];this._element&&n&&this._element.removeEventListener(e,n)})}_addEvents(){const{events:t}=this.props;if(!t)return;const e=Object.keys(t);this.events=t,e.forEach(n=>{const o=t==null?void 0:t[n];this._element&&o&&this._element.addEventListener(n,o)})}initComponents(t){this.components=t}_registerEvents(t){t.on(k.EVENTS.INIT,this.init.bind(this)),t.on(k.EVENTS.FLOW_RENDER,this._render.bind(this))}_createResources(){const{tagName:t}=this._meta;this._element=this._createDocumentElement(t)}init(){this._createResources()}componentDidUpdate(t,e){return t===e}get element(){return this._render(),this._element}_render(){this._removeEvents();const t=this.render();this._element&&(this._element.innerHTML="",this._element.append(t.template),this._addEvents())}render(){return this._templateEngine.compile(this.props,this.components)}getContent(){return this.element}static getStyles(){return this._style}_makePropsProxy(t){return new Proxy(t,{set:(e,n,o)=>(e[n]=o,this.eventBus().emit(k.EVENTS.FLOW_RENDER),!0),deleteProperty(){throw new Error("нет доступа")}})}_createDocumentElement(t){return document.createElement(t)}show(){const t=this.getContent();t&&(t.style.display="block")}hide(){const t=this.getContent();t&&(t.style.display="none")}};let b=k;l(b,"_style"),l(b,"EVENTS",{INIT:"init",FLOW_CDM:"flow:component-did-mount",FLOW_RENDER:"flow:render",FLOW_CDU:"flow:component-did-update"});const st=`
<div class="input-wrapper">
    <input placeholder="{{ placeholder }}" type="{{ type }}" class="input" name="{{ name }}" />
</div>
`,j=`.input-wrapper{height:100%;width:100%;position:relative}.input-wrapper:after{color:var(--red);font-size:11px;left:8px;position:absolute;display:block;content:"";bottom:-15px}.input-wrapper--alert-first_name:after,.input-wrapper--alert-second_name:after,.input-wrapper--alert-display_name:after{content:"Первая буква должна быть заглавной, не должно быть цифр и спецсимволов кроме дефиса"}.input-wrapper--alert-login:after{content:"От 3 до 20 символов, допустимы латиница, цифры и знаки(-, _), должна быть хотя бы одна буква"}.input-wrapper--alert-email:after{content:"Допустимы латиница, цифры и знаки(-, _), должен быть знак @ и точка после него, перед точкой должны быть буквы"}.input-wrapper--alert-phone:after{content:"От 10 до 15 символов, состоит из цифр, может начинается с плюса"}.input-wrapper--alert-oldPassword:after,.input-wrapper--alert-newPassword:after,.input-wrapper--alert-password:after{content:"От 8 до 40 символов, обязательно хотя бы одна заглавная буква и цифра"}.input-wrapper .input{width:100%;height:100%;border-radius:15px;border:0;box-shadow:0 3.7px 3.7px #00000040;padding-left:15px;box-sizing:border-box;margin:0}.input-wrapper .input--alert{border:1px solid var(--red)}
`,w={login:/^(?!\d+$)[\da-zA-Z_-]+$/,password:/^(?![a-z\d]+$)(?![a-zA-Z]+$).{8,40}$/,email:/^[a-zA-Z-_0-9]+@[a-zA-Z-_]+\.[a-zA-Z-_]+$/,name:/^[A-ZА-Я][А-Яа-яA-Za-z-]*$/,phone:/^\+[0-9]{10,14}$|^[0-9]{10,15}$/};function nt(h,t){return h.test(t.value)}class d extends b{constructor(t={}){t.events||(t.events={}),t.events.focusout=e=>{var r,i;if(!this.props.regExp)return;const n=e==null?void 0:e.target,o=nt(this.props.regExp,n),s=this.props.name;o?(n.classList.remove("input--alert"),(i=n.parentElement)==null||i.classList.remove(`input-wrapper--alert-${s}`)):(n.classList.add("input--alert"),(r=n.parentElement)==null||r.classList.add(`input-wrapper--alert-${s}`))},super("input-component",t,st,j),d._style=j}}const ot=`
<button class="button {{ class }}" type="submit">{{ text }}</button>
`,J=`.button{width:100%;height:100%;border-radius:15px;background-color:var(--blue);color:var(--white);font-weight:700;font-size:18px;text-transform:uppercase;cursor:pointer;border:0}.button--exit{padding:10px;background-color:var(--red)}
`;class y extends b{constructor(t={}){super("button-component",t,ot,J),y._style=J}}function rt(h){let t="?";return Object.keys(h).forEach(e=>{t+=`${e}=${Array.isArray(h[e])?h[e].join(","):h[e]}&`}),t=t.replace(/&$/,""),t}class L{constructor(){l(this,"get",(t,e={})=>this.request(t,{...e,method:"GET"},e.timeout));l(this,"put",(t,e={})=>this.request(t,{...e,method:"PUT"},e.timeout));l(this,"post",(t,e={})=>this.request(t,{...e,method:"POST"},e.timeout));l(this,"delete",(t,e={})=>this.request(t,{...e,method:"DELETE"},e.timeout));l(this,"request",(t,e,n=5e3)=>new Promise((o,s)=>{const{method:r,data:i}=e,a=new XMLHttpRequest;r==="GET"&&i?a.open(r,t+rt(i)):a.open(r,t),i instanceof FormData||a.setRequestHeader("Content-Type",e.ContentType||"application/json"),a.withCredentials=!0;let c=i;(e.ContentType==="application/json"||!e.ContentType&&!(i instanceof FormData))&&(c=JSON.stringify(i)),a.onload=function(){o(a)};const p=g=>{s(g)};a.timeout=n,a.onabort=p,a.onerror=p,a.ontimeout=p,r==="GET"||!i?a.send():a.send(c)}))}}class it{constructor(){l(this,"_url");l(this,"_http");this._url="https://ya-praktikum.tech/api/v2/auth/",this._http=new L}signIn({login:t,password:e}){return this._http.post(this._url+"signin",{data:{login:t,password:e}})}signUp(t){return this._http.post(this._url+"signup",{data:t})}getUser(){return this._http.get(this._url+"user")}logOut(){return this._http.post(this._url+"logout")}}class P{constructor(){l(this,"_authApi");this._authApi=new it}signIn(t){return this._authApi.signIn(t).then(e=>e).catch(e=>console.error(e))}signUp(t){return this._authApi.signUp(t).then(e=>e).catch(e=>console.error(e))}getUser(){return this._authApi.getUser().then(t=>JSON.parse(t.response))}logout(){return this._authApi.logOut().catch(t=>{console.error(t)})}}class $ extends b{constructor(e={}){super("registration-component",e,Q,R);l(this,"_authController");this.initComponents(),this._authController=new P,$._style=R+y.getStyles()+d.getStyles()}initComponents(){const e=new d({placeholder:"Логин",type:"text",name:"login",regExp:w.login}).getContent(),n=new d({placeholder:"Пароль",type:"password",name:"password",regExp:w.password}).getContent(),o=new d({placeholder:"Почта",type:"email",name:"email",regExp:w.email}).getContent(),s=new d({placeholder:"Имя",type:"text",name:"first_name",regExp:w.name}).getContent(),r=new d({placeholder:"Фамилия",type:"text",name:"second_name",regExp:w.name}).getContent(),i=new d({placeholder:"Телефон",type:"phone",name:"phone",regExp:w.phone}).getContent(),a=new y({text:"Зарегистрироваться",events:{click:c=>this.onSubmit(c)}}).getContent();this.components={buttonComponent:a,loginComponent:e,passwordComponent:n,emailComponent:o,firstNameComponent:s,lastNameComponent:r,phoneComponent:i}}onSubmit(e){var n;if(e.preventDefault(),this.components){const o={};(n=Object.values(this.components))==null||n.forEach(s=>{const r=s.querySelector("input");r&&(r.focus(),r.blur(),o[r.name]=r.value)}),this.isSignUpData(o)&&this._authController.signUp(o).then(s=>{(s==null?void 0:s.status)===200&&U.go("/chat")})}}isSignUpData(e){return!!(e!=null&&e.first_name)&&!!(e!=null&&e.second_name)&&!!(e!=null&&e.login)&&!!(e!=null&&e.email)&&!!(e!=null&&e.password)&&!!(e!=null&&e.phone)}}const at=`
<main 
    class="body">
    <form class="form">
        <loginComponent placeholder="Логин" 
               type="text" 
               class="form__field" 
               name="login"></loginComponent>
        <passwordComponent placeholder="Пароль" type="password" class="form__field" name="password"></passwordComponent>
        <div class="buttons">
            <buttonComponent class="buttons__item buttons__item--small"></buttonComponent>
            <regisctrationButton class="buttons__item buttons__item--big">Зарегистрироваться</regisctrationButton>
        </div>
    </form>
</main>
`,M=`.body{display:flex;flex-direction:row;justify-content:center;align-items:center;height:100dvh;margin:0;box-sizing:border-box}
`;class q extends b{constructor(e={},n){e.events=n;super("auth-component",e,at,M);l(this,"_authController");this.initComponents(),this._authController=new P,q._style=M+y.getStyles()+d.getStyles()}initComponents(){const e=new d({placeholder:"Логин",type:"text",name:"login",regExp:w.login}).getContent(),n=new d({placeholder:"Пароль",type:"password",name:"password",regExp:w.password}).getContent(),o=new y({text:"Войти",events:{click:r=>this.onSubmit(r)}}).getContent(),s=new y({text:"Зарегистрироваться",events:{click:r=>{r==null||r.preventDefault(),U.go("/sign-up")}}}).getContent();this.components={buttonComponent:o,loginComponent:e,passwordComponent:n,regisctrationButton:s}}async onSubmit(e){var n;if(e.preventDefault(),this.components){const o={login:"",password:""};let s=!1;if((n=Object.values(this.components))==null||n.forEach(r=>{const i=r.querySelector("input");i&&(i.focus(),i.blur(),i.classList.contains("input--alert")&&(s=!0),o[i.name]=i.value)}),!s){await this._authController.logout();const r=await this._authController.signIn(o);(r==null?void 0:r.status)===200&&U.go("/messenger")}}}}const lt=`
<main class="body">
    <div id="left-side-menu-wrapper" class="left-side-menu__wrapper">
        <section class="left-side-menu">
            <ul class="left-side-menu__list">
                <li class="left-side-menu__list-item" id="create-chat">Создать чат</li>
                <li class="left-side-menu__list-item" id="settings-link">Настройки</li>
            </ul>
            <div class="buttons">
                <exitButton></exitButton>
            </div>
        </section>
        <section class="create-chat-popup popup-with-users">
            <createChatInputComponent class="input-component create-chat-name"></createChatInputComponent>
            <addUserToChatBeforeCreateChatComponent class="input-component"></addUserToChatBeforeCreateChatComponent>
            <ul class="users-for-chat"></ul>
            <ul class="users-in-chat"></ul>
            <createChatButtonComponent class="create-chat-popup__btn"></createChatButtonComponent>
        </section>
        <section class="add-users-chat-popup popup-with-users">
            <addUserToChatComponent class="input-component"></addUserToChatComponent>
            <ul class="users-for-chat"></ul>
            <ul class="users-in-chat">
                <li for="let user of chatUsers" class="users-in-chat__item"><span>{{ user.login }}</span><span data-id="{{ user.id }}" class="remove-user clickable">Удалить</span></li>
            </ul>
            <addUserToChatButtonComponent class="create-chat-popup__btn"></addUserToChatButtonComponent>
        </section>
        <div id="shadow" class="shadow"></div>
    </div>
    <section class="chat-preview__container">
        <div class="search__wrapper">
            <div id="click-at-sandwich" (click)="showLeftSideMenu()" class="sandwich__wrapper">
                <div class="sandwich"></div>
            </div>
            <input placeholder="Поиск" class="input search" type="search" name="" id="">
        </div>
    
        <ul class="chat-preview__list">
            <li for="let chat of chats" data-id="chat-{{ chat.id }}" class="chat-preview">
                <img class="chat-preview__image" src="/icon.svg" alt="">
                <div class="chat-preview__right-side">
                    <h1 class="chat-preview__text chat-preview__text--title">{{ chat.title }}</h1>
                </div>
            </li>
        </ul>
    </section>
    <section class="chat">
        <div class="chat__title">
            <span class="clickable" id="chat-settings">{{ chatTitle }}</span>
        </div>
        <ul class="chat__feed">
            <li for="let message of messages" class="chat__message {{ message.class }}">
                <img class="chat-preview__image" src="/icon.svg" alt="">
                <p class="chat__text">{{ message.content }}</p>
            </li>
        </ul>
        <textarea id="chat-textarea" type="text" placeholder="Писать сюда..." class="input chat__input" name="message"></textarea>
    </section>

</main>
`,W=`.chat-preview{display:flex;flex-direction:row;align-items:center;font-family:Inter,sans-serif;padding:5px}.chat-preview:hover{background-color:var(--orange);cursor:pointer}.chat-preview__image{width:50px;height:50px;border-radius:50%;object-fit:cover;object-position:50% 50%}.chat-preview__container{position:relative;width:337px;height:100dvh;background-color:var(--bg-color);display:flex;flex-direction:column}.chat-preview__text{font-style:normal;font-weight:700;font-size:15px;margin:0}.chat-preview__text--title{margin-bottom:12px}.chat-preview__right-side{margin-left:10px}.chat-preview__list{padding-left:0}.input{margin-top:18px;margin-bottom:16px;width:263px;height:28px;border-radius:15px;border-width:0;padding-left:10px}.input:focus{outline:1px solid black}.search__wrapper{display:flex;flex-direction:row;align-items:center}.sandwich__wrapper{position:relative;width:30px;height:24px;margin-left:15px;margin-right:10px;cursor:pointer}.sandwich,.sandwich:after,.sandwich:before{display:block;background-color:var(--black);position:absolute;top:50%;height:4px;width:30px;transform:translateY(-50%);border-radius:2px}.sandwich:after{content:"";margin-top:-8px}.sandwich:before{content:"";margin-top:8px}.body{display:flex;flex-direction:row;width:100%}.chat{position:relative;flex-grow:1;padding-bottom:90px;display:flex;flex-direction:column;padding-right:0;padding-top:50px}.chat__input{background-color:var(--bg-color);min-height:45px;position:absolute;bottom:25px;width:90%;left:50%;transform:translate(-50%);box-sizing:border-box;resize:none;overflow:hidden;margin-bottom:0;padding-top:14px}.chat__feed{list-style-type:none;margin-bottom:0;height:calc(100dvh - 156px);width:calc(100dvw - 377px);overflow:auto;margin-top:0;padding-top:10px;padding-right:10px}.chat__text{margin-top:0;background-color:var(--bg-color);padding:20px 10px 20px 20px;border-radius:15px}.chat__message{width:400px;display:flex;gap:5px}.chat__message--right{flex-direction:row-reverse;margin-left:auto}.chat__title{width:100dvw;background-color:var(--bg-color);height:50px;position:fixed;line-height:50px;font-size:20px;font-weight:700;padding-left:15px;color:var(--black);top:0}.buttons{width:100%;justify-content:center;position:absolute;bottom:25px}.buttons__item{height:45px;line-height:45px}.left-side-menu{display:flex;position:absolute;left:0;top:0;width:334px;height:100dvh;z-index:2;background-color:var(--bg-color)}.left-side-menu__list{display:flex;flex-direction:column;list-style-type:none}.left-side-menu__list-item{height:56px;line-height:56px;padding-left:24px;cursor:pointer;font-size:20px;font-weight:700}.left-side-menu__wrapper{display:none;width:0;overflow-y:hidden}.shadow{top:0;left:0;position:absolute;background-color:var(--shadow);width:100dvw;height:100dvh;z-index:1}.add-users-chat-popup,.create-chat-popup{top:50%;left:50%;transform:translate(-50%,-50%);padding:25px;position:absolute;z-index:2;background-color:var(--bg-color);border-radius:15px;display:none;flex-direction:column;gap:10px}.add-users-chat-popup__btn,.create-chat-popup__btn{padding-top:10px;padding-bottom:10px;background-color:var(--blue);border-radius:15px}.input-component{height:40px}.clickable{cursor:pointer}.users-in-chat,.users-for-chat{list-style:none}.users-for-chat{height:100px;overflow-y:auto;border:1px solid var(--black)}.users-in-chat{padding-left:0;display:flex;flex-direction:column}.users-in-chat__item{display:flex;justify-content:space-between}
`;class ct{constructor(){l(this,"_url");l(this,"_http");this._url="https://ya-praktikum.tech/api/v2/chats/",this._http=new L}createChat(t){return this._http.post(this._url,{data:{title:t}})}getChats(){return this._http.get(this._url)}addUserToChat(t){return this._http.put(this._url+"users",{data:t})}getToken(t){return this._http.post(this._url+"token/"+t)}getUsers(t){return this._http.get(this._url+t+"/users")}deleteChatUser(t,e){return this._http.delete(this._url+"users",{data:{users:[e],chatId:t}})}}class pt{constructor(){l(this,"_chatApi");this._chatApi=new ct}createChat(t){return this._chatApi.createChat(t).then(e=>JSON.parse(e.response)).catch(e=>console.error(e))}getChats(){return this._chatApi.getChats().then(t=>JSON.parse(t.response)).catch(t=>(console.error(t),[]))}addUserToChat(t){return this._chatApi.addUserToChat(t).catch(e=>console.error(e))}getToken(t){return this._chatApi.getToken(t).then(e=>JSON.parse(e.response)).catch(e=>console.error(e))}getUsers(t){return this._chatApi.getUsers(t).then(e=>JSON.parse(e.response)).catch(e=>console.error(e))}deleteChatUsers(t,e){return this._chatApi.deleteChatUser(t,e).catch(n=>console.error(n))}}class ht{constructor(){l(this,"_url");l(this,"_http");this._url="https://ya-praktikum.tech/api/v2/user/",this._http=new L}searchUser(t){return this._http.post(this._url+"search",{data:{login:t}})}changeUserData(t){return this._http.put(this._url+"profile",{data:t})}changeUserPassword(t){return this._http.put(this._url+"password",{data:t})}changeUserAvatar(t){return this._http.put(this._url+"profile/avatar",{data:t,ContentType:"multipart/form-data"})}}class V{constructor(){l(this,"_userApi");this._userApi=new ht}searchUser(t){return this._userApi.searchUser(t).then(e=>JSON.parse(e.response)).catch(e=>console.error(e))}changeUserData(t){return this._userApi.changeUserData(t).catch(e=>console.error(e))}changeUserPassword(t){return this._userApi.changeUserPassword(t).catch(e=>console.error(e))}changeUserAvatar(t){return this._userApi.changeUserAvatar(t).then(e=>JSON.parse(e.response))}}class ut{constructor(){l(this,"_url");this._url="wss://ya-praktikum.tech/ws/"}connectChat(t,e,n){return new WebSocket(`${this._url}chats/${t}/${e}/${n}`)}}class dt{constructor(){l(this,"_websocketApi");this._websocketApi=new ut}connectChat(t,e,n){return this._websocketApi.connectChat(t,e,n)}}class z extends b{constructor(e={}){let n=!1;e.click=async s=>{var r,i,a,c,p,g,f,x,I,N,E,S;if((r=s==null?void 0:s.target)!=null&&r.closest("#click-at-sandwich")){const m=document.querySelector("#left-side-menu-wrapper"),_=document.querySelector(".add-users-chat-popup"),u=document.querySelector(".left-side-menu");u&&(u.style.display="flex"),m&&(m.style.display="flex"),_&&(_.style.display="none")}if((i=s==null?void 0:s.target)!=null&&i.closest("#shadow")){const m=document.querySelector("#left-side-menu-wrapper"),_=document.querySelector(".add-users-chat-popup");m&&(m.style.display="none");const u=document.querySelector(".create-chat-popup");u&&(u.style.display="none"),_&&(_.style.display="none")}if((a=s==null?void 0:s.target)!=null&&a.closest("#create-chat")){const m=document.querySelector(".create-chat-popup");m&&(m.style.display="flex")}if((c=s==null?void 0:s.target)!=null&&c.closest("#settings-link")&&U.go("/settings"),(p=s==null?void 0:s.target)!=null&&p.closest(".remove-user")){const m=(g=s==null?void 0:s.target)==null?void 0:g.closest(".remove-user"),_=m.dataset.id;this._chatId&&_&&this._chatController.deleteChatUsers(String(this._chatId),_).then(()=>{var u;(u=m.parentElement)==null||u.remove()})}if((f=s==null?void 0:s.target)!=null&&f.closest("#chat-settings")){const m=document.querySelector(".add-users-chat-popup"),_=document.querySelector("#left-side-menu-wrapper"),u=document.querySelector(".left-side-menu");_&&(_.style.display="flex"),m&&(m.style.display="flex"),u&&(u.style.display="none")}if((x=s==null?void 0:s.target)!=null&&x.closest(".chat-preview")){const m=(I=(s==null?void 0:s.target).dataset.id)==null?void 0:I.split("-")[1];if(this._messages=[],this._chatSocket&&(this._chatSocket.close(1e3),this._chatSocket=void 0),this._chatTitle=((S=(E=(N=s==null?void 0:s.target)==null?void 0:N.closest(".chat-preview"))==null?void 0:E.querySelector(".chat-preview__text--title"))==null?void 0:S.textContent)||" ",this._chatId=Number(m),m!==void 0&&this._userId){this._getUsers(m);const{token:_}=await this._chatController.getToken(String(m));this._chatSocket=this._webSocketController.connectChat(String(this._userId),String(m),_),this._chatSocket.onopen=()=>{var C;(C=this._chatSocket)==null||C.send(JSON.stringify({content:"0",type:"get old"})),this._messageIndex=21;const u=setInterval(()=>{this._chatSocket?this._chatSocket.send(JSON.stringify({type:"ping"})):clearInterval(u)},5e3)},this._chatSocket.addEventListener("message",u=>{var C;if(!(JSON.parse(u.data).type==="pong"||JSON.parse(u.data).type==="user connected")){if(JSON.parse(u.data).type==="message"){const v={content:JSON.parse(u.data).content,class:JSON.parse(u.data).user_id===Number(this._userId)?"chat__message--left":"chat__message--right"};this._messages.push(v)}else if(JSON.parse(u.data).length){const v=JSON.parse(u.data).map(T=>(T.class=T.user_id===Number(this._userId)?"chat__message--left":"chat__message--right",T)).reverse();this._messages.unshift(...v),(C=this._chatSocket)==null||C.send(JSON.stringify({content:this._messageIndex,type:"get old"})),this._messageIndex+=20}this.setProps({arrays:{messages:this._messages,chats:this._chats,chatUsers:this._chatUsers},chatTitle:this._chatTitle})}})}}},e.keydown=s=>{var i,a;if(s.repeat)return;n=!!((s==null?void 0:s.target).closest("#chat-textarea")&&s.key==="Control")||n;const r=!!(!s.repeat&&(s==null?void 0:s.target).closest("#chat-textarea")&&s.key==="Enter");if(n&&r){const c=(i=(s==null?void 0:s.target).closest("#chat-textarea"))==null?void 0:i.value;console.log(c),(a=this._chatSocket)==null||a.send(JSON.stringify({content:c,type:"message"}))}},e.keyup=s=>{n=s.key!=="Control"&&n};super("chat-component",{fullMessage:"Полное сообщение",message:"Последнее сообщение из ...",chatTitle:" ",events:e,arrays:{chats:[{id:202,title:"Чат"}],messages:[{}]}},lt,W);l(this,"_chatController");l(this,"_userController");l(this,"_authController");l(this,"_webSocketController");l(this,"_usersToChat",[]);l(this,"_userId");l(this,"_chats",[]);l(this,"_messages",[]);l(this,"_chatSocket");l(this,"_messageIndex",0);l(this,"_chatTitle"," ");l(this,"_chatId");l(this,"_chatUsers",[]);this.initComponents(),this._chatController=new pt,this._userController=new V,this._authController=new P,this._webSocketController=new dt,z._style=d.getStyles()+W+y.getStyles(),this._chatController.getChats().then(s=>{const r=s.map((i,a)=>(i.index=a,i));this.setProps({arrays:{chats:r},chatTitle:this._chatTitle}),this._chats=r}),this._authController.getUser().then(s=>{this._userId=s.id}),window.onload=()=>{const s=document.querySelector(".chat"),r={attributes:!0,childList:!0,subtree:!0},i=new MutationObserver(()=>{var a;(a=document.querySelector(".chat__feed"))==null||a.scrollTo(0,1e5)});s&&i.observe(document,r)}}initComponents(){const e=new d({placeholder:"Название чата",type:"text",name:"create-chat"}).getContent(),n=new y({text:"Создать чат",events:{click:async()=>{const a=document.querySelector(".create-chat-name input").value,c=await this._chatController.createChat(a);await this._chatController.addUserToChat({users:this._usersToChat.map(p=>Number(p.id)),chatId:c.id})}}}).getContent(),o=new y({text:"Добавить пользователей",events:{click:async()=>{this._chatId&&await this._chatController.addUserToChat({users:this._usersToChat.map(a=>Number(a.id)),chatId:this._chatId})}}}).getContent(),s=new y({text:"Выйти",class:"button--exit",events:{click:async()=>{this._authController.logout().then(()=>{U.go("/")})}}}).getContent(),r=new d({placeholder:"Найти пользователя",type:"text",events:{input:a=>{var p;const c=(p=a==null?void 0:a.target)==null?void 0:p.value;this._addUsers((a==null?void 0:a.target).closest(".popup-with-users"),c)}}}).getContent(),i=new d({placeholder:"Найти пользователя",type:"text",events:{input:a=>{const c=(a==null?void 0:a.target).value;this._addUsers((a==null?void 0:a.target).closest(".popup-with-users"),c)}}}).getContent();this.components={createChatButtonComponent:n,createChatInputComponent:e,addUserToChatBeforeCreateChatComponent:r,exitButton:s,addUserToChatComponent:i,addUserToChatButtonComponent:o}}_addUsers(e,n){this._userController.searchUser(n).then(o=>{const s=e==null?void 0:e.querySelector(".users-for-chat");if(o&&s){s.textContent="";const r=[];o.forEach((i,a)=>{const c=document.createElement("li");c.classList.add("clickable"),c.textContent=i.login,c.dataset.id=String(a),c.addEventListener("click",()=>{var f;this._usersToChat.push(i);const p=document.createElement("li");p.classList.add("clickable","users-in-chat__item"),p.textContent=i.login;const g=document.createElement("span");g.textContent="Убрать",g.addEventListener("click",()=>{this._usersToChat=this._usersToChat.filter(x=>x.login!==i.login),p.remove()}),p.append(g),(f=e.querySelector(".users-in-chat"))==null||f.append(p)}),r.push(c)}),s.append(...r)}})}_getUsers(e){this._chatController.getUsers(e).then(n=>{this._chatUsers=n})}}const mt=`
<main class="body">
    <h1>{{ errorCode }}</h1>
</main>
`,Z=`.body{display:flex;flex-direction:row;justify-content:center;align-items:center;height:100dvh;margin:0;box-sizing:border-box;font-size:50px}
`;class B extends b{constructor(){const e=new URLSearchParams(window.location.search).get("errorCode")??"500";super("chat-component",{errorCode:e},mt,Z),B._style=Z}}const _t=`
<main class="body">
    <form id="avatar" class="form form--without-gap">
        <img class="form__icon" src="/icon.svg" alt="">
        <label class="input-file">
            <input class="input-file__input" type="file" name="avatar">
            <span class="input-file__button">Поменять аватар</span>           
        </label>
    </form>
    <form class="form">
        <firstNameComponent placeholder="Имя" type="text" class="form__field" name="first_name"></firstNameComponent>
        <lastNameComponent placeholder="Фамилия" type="text" class="form__field" name="second_name"></lastNameComponent>
        <displayNameComponent placeholder="Отображаемое имя" type="text" class="form__field" name="display_name"></displayNameComponent>
        <loginComponent placeholder="Логин" type="text" class="form__field" name="login"></loginComponent>
        <emailComponent placeholder="Почта" type="email" class="form__field" name="email"></emailComponent>
        <phoneComponent placeholder="Телефон" type="phone" class="form__field" name="phone"></phoneComponent>
        <div class="buttons">
            <saveDataButtonComponent class="buttons__item buttons__item--small" type="submit">Сохранить</saveDataButtonComponent>
        </div>
    </form>
    <hr class="hr-line">
    <form class="form">
        <oldPasswordComponent placeholder="Старый пароль" type="text" class="form__field" name="oldPassword"></oldPasswordComponent>
        <newPasswordComponent placeholder="Новый пароль" type="password" class="form__field" name="newPassword"></newPasswordComponent>
        <div class="buttons">
            <savePasswordButtonComponent class="buttons__item buttons__item--small" type="submit">Сохранить</savePasswordButtonComponent>
        </div>
    </form>
</main>
`,F=`.body{background-color:var(--bg-color);height:calc(100dvh - 72px);width:calc(100dvw - 72px);gap:26px;display:flex;flex-direction:column;padding:36px}.form{width:100%;border-radius:0;padding:0;gap:21px;box-shadow:none}.form__field{height:45px}.form--without-gap{gap:0}.form__icon{border-radius:50%}.buttons{justify-content:center}.buttons__item{height:33px;line-height:33px}.input-file{position:relative;display:inline-block}.input-file__button{position:relative;display:inline-block;cursor:pointer;outline:none;font-size:14px;vertical-align:middle;color:#4965d6;text-align:center;border-radius:4px;line-height:14px;height:14px;box-sizing:border-box;border:none;margin:0;transition:background-color .2s;padding:0;text-decoration:underline}.input-file__input{position:absolute;z-index:-1;opacity:0;display:block;width:0;height:0}
`;class D extends b{constructor(){super("chat-component",{events:{change:n=>{var s;if((s=n==null?void 0:n.target)==null?void 0:s.files){const r=document.getElementById("avatar"),i=new FormData(r);this._userController.changeUserAvatar(i).then(a=>{a.avatar&&(document.querySelector(".form__icon").src="https://ya-praktikum.tech/api/v2/resources"+a.avatar)})}}}},_t,F);l(this,"_authController");l(this,"_userController");this._authController=new P,this._userController=new V,this.initComponents(),this._getUserInfo(),D._style=F+d._style+y._style}initComponents(){const e=new d({placeholder:"Имя",type:"text",name:"first_name",regExp:w.name}).getContent(),n=new d({placeholder:"Фамилия",type:"text",name:"second_name",regExp:w.name}).getContent(),o=new d({placeholder:"Отображаемое имя",type:"text",name:"display_name",regExp:w.name}).getContent(),s=new d({placeholder:"Логин",type:"text",name:"login",regExp:w.login}).getContent(),r=new d({placeholder:"Почта",type:"email",name:"email",regExp:w.email}).getContent(),i=new d({placeholder:"Телефон",type:"phone",name:"phone",regExp:w.phone}).getContent(),a=new y({text:"Сохранить",events:{click:f=>this.onSubmit(f,"data")}}).getContent(),c=new d({placeholder:"Пароль",type:"password",name:"oldPassword",regExp:w.password}).getContent(),p=new d({placeholder:"Пароль",type:"password",name:"newPassword",regExp:w.password}).getContent(),g=new y({text:"Сохранить",events:{click:f=>this.onSubmit(f,"password")}}).getContent();this.components={saveDataButtonComponent:a,savePasswordButtonComponent:g,loginComponent:s,oldPasswordComponent:c,newPasswordComponent:p,emailComponent:r,firstNameComponent:e,lastNameComponent:n,phoneComponent:i,displayNameComponent:o}}onSubmit(e,n){var o;if(e.preventDefault(),this.components){const s={};(o=Object.values(this.components))==null||o.forEach(r=>{const i=r.querySelector("input");i&&(n==="password"&&i.type===n||n==="data"&&i.type!=="password")&&(i.focus(),i.blur(),s[i.name]=i.value)}),n==="data"?this._userController.changeUserData(s).then(r=>{(r==null?void 0:r.status)===200&&this._showMessage("Изменения сохранены")}):this._userController.changeUserPassword(s).then(r=>{(r==null?void 0:r.status)===200&&this._showMessage("Пароль изменен")})}}_getUserInfo(){this._authController.getUser().then(e=>{document.querySelector("input[name=first_name]").value=e.first_name,document.querySelector("input[name=second_name]").value=e.second_name,document.querySelector("input[name=display_name]").value=e.display_name,document.querySelector("input[name=login]").value=e.login,document.querySelector("input[name=email]").value=e.email||"",document.querySelector("input[name=phone]").value=e.phone||"",e.avatar&&(document.querySelector(".form__icon").src="https://ya-praktikum.tech/api/v2/resources"+e.avatar)})}_showMessage(e){const n=document.createElement("div");n.classList.add("alert-popup"),n.textContent=e,document.body.append(n),setTimeout(()=>{n.remove()},5e3)}}U.use("/",q).use("/sign-up",$).use("/auth",q).use("/messenger",z).use("/error",B).use("/settings",D).start();
